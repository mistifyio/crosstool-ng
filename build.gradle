buildscript {
    repositories {
        jcenter()
        maven { url "https://plugins.gradle.org/m2/" }
        dependencies {
            classpath 'org.ysb33r.gradle:gnumake:1.0.2'
            classpath 'nu.studer:gradle-credentials-plugin:1.0.1'
        }
    }
}

ext.buildNumber = project.hasProperty('buildNumber') ? buildNumber : '9999'

group = 'org.mistify'
version = "1.2.${buildNumber}"

apply plugin: 'org.ysb33r.gnumake'
apply plugin: 'nu.studer.credentials'

ext.buildDir = 'build' as File
ext.buildOutputDir = "${buildDir}/compiledOutput" as File

gnumake {
    defaultFlags O: buildOutputDir
}

task createBuildDirs()<<{
  buildOutputDir.mkdirs()
}

task bootstrapToolchain(type: Exec, dependsOn: createBuildDirs){
    commandLine 'bash', '-c', './bootstrap'
}

task configureToolchain(type: Exec, dependsOn: bootstrapToolchain){
    commandLine 'bash', '-c', "./configure --enable-local --prefix=${buildOutputDir}"
}

makeBuild.mustRunAfter makeClean
makeBuild.dependsOn configureToolchain

task archiveBuildOutput(type: Zip, dependsOn: makeBuild){
    from buildOutputDir
    destinationDir file("${buildDir}/distributions")
}

task build(dependsOn: [makeClean, makeBuild, archiveBuildOutput])

//task makeDirClean(type: GnuMakeBuild, group: 'GNU Make tasks') {
//    description "Executes make <project>-dirclean"
//
//    makeInputs { file makeFile }
//    makeOutputs { file makeFile }
//
//    chDir buildRootDir
//    targets "${project.name}-dirclean"
//}


apply plugin: 'maven-publish'

ext.s3Key = credentials.s3

publishing {
    repositories {
        maven {
            url "s3://omniti-mystify-artifacts/libs-release-local"
            credentials(AwsCredentials) {
                accessKey 'AKIAIVD4UP67JBMGTSRA'
                secretKey s3Key
            }
        }
    }

    publications {
        mavenJava(MavenPublication) {
            artifact archiveBuildOutput
        }
    }
}

task wrapper(type: Wrapper) {
    gradleVersion = '2.4'
}
